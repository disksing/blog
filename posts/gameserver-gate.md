title:  服务器组件之网关
description: 
time: 2015/03/11 11:40
category: gamedev
++++++++

## 提要

本文介绍网络游戏服务器中常用的组件：网关。主要讨论网关的作用，与网关相关的服务器架构设计，及我们项目
中的具体实现（Go语言HTTP）。

## 网关的作用

### 1. 维持连接

我第一次接触网关的时候做的是MMORPG游戏，当时的服务器架构是分场景的，即每个game维护一个或多个游戏场景。
而且MMORPG一般来说用的是TCP长连接做消息通信，于是当玩家从一个场景切进另一个场景时需要断开与前一个服务
器的连接，再去连接后一个服务器，这时候如果网络不通畅，常常就掉线了。

引入网关做代理可以很好的解决了这个问题。客户端启动后连接的是网关，网关再去连接场景服务器并转发所有消
息包。切换场景时客户端与网关的连接是不断的，由网关负责去连接新的场景，因为网关和游戏服务器通常在同一
局域网内，所以掉线的问题大大改善了。

### 2. 串并转换

网关可以更进一步增加串并转换的功能。网关和每个game只维护单一连接，将多个客户端的并发连接转为串行方式
发往game。这样做的好处是客户端切换场景时网关不用重新建立TCP连接了，可靠性更高。

另外game处理消息的逻辑可以更加简洁，不用处理I/O复用，因为所有的消息来自单个TCP连接（单网关）或者固定
数量的几个TCP连接（多网关的情况）。

### 3. 权限控制

在多进程的网络游戏架构中，game除了要处理客户端的消息，同时还会处理其他进程的消息，比如账号、GM工具等。
出于安全原因，一定需要把客户端的消息隔离开来加以限制。

一种方法是考虑进程开启后不同的服务监听不同的ip和端口，内部使用的服务只绑定内网ip，从而起到隔离的效果。

我们采用的另一种做法是使用网关来做权限控制，直接将客户端的请求限制在HTTP的某个路径下，这样一来所有的
服务器进程都只监听单一ip和端口，简化了架构设计。

### 4. 运维方便

游戏服务器经常需要开服、合服，还有硬件故障等原因导致不得不做服务器迁移。如果game直接对客户端提供服务，
服务发生变更时往往需要客户端退出重新走登录流程。如果使用网关，在服务器内部发生地址变更时只需要保证网
关得到更新并发起重连，客户端甚至根本觉察不到。

部署时可以把所有网关绑定至同一个域名，于是客户端连接服务器时通过统一的域名即可，不用关心具体的game服
务器地址。同时网关可以很轻松地动态增减，服务器的网络也有了简单的网络负载均衡功能。

### 5. 省钱

增加新的网关进程意味着我们需要购买更多的服务器，怎么会省钱呢？因为将外网带宽这种比较昂贵的资源集中管
理可以使其利用率更高，自然就达到省钱的效果了。

以我们使用的阿里云ECS为例。

## 设计与实现


